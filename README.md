# BFR Data Analysis Website (Backend)
### Abstract
- **Creates an API for frontend to upload and manage the car's run logs (later abbreviated as "data") stored in a MongoDB database:**  
   Post data request -> backend uploads data to database & updates master file in the database  
   Delete data request -> backend deletes data from database & updates master file in the database
- **Generates real-time customizable time-series graphs and passes to frontend:**    
   Get plot request -> backend gets parameters from query -> sends params to a python script -> python script writes HTML to a temporary local file -> backend reads the local file and sends back to frontend
- **Ask the master file in the database for a hierarchical list of all existing data:**  
   Get datatree request -> backend fetches master file from database -> converts it to a tree-structured JSON and sends back to frontend

### Preparations
- **MongoDB database:** Create a cluster that contains 2 databases: main (for storing data) and master (for storing what data are stored).
   Master: has one collection called "datalists", which has one document. It has one array entry with key "list" and values of type: { "collectionName": data's collection's name, its 2 super folders' names separated by a slash, "entryName": data's name }. Each time a data is uploaded/removed, this list will be updated.  
   Main: has multiple collections whose names are two super folders separated by a slash. Each collection stores multiple entries of type: { "uploader": uploader's name, "uploadDate": a Date object formatted as a string (autogenerated when uploaded), "name": name of the data, "fileName": original file's name, "dataDate": a string that represents when this data was acquired (may not be parsable as a Date object), "comments": additional comments, "data": the contents of the log file }
- **Data-plotting Python script**  
   Adapted from this [repository](https://github.com/liug26/bfr-mk8-software/tree/main/data-analysis). Sends arguments to the script and reads outputs (currently from a temporary local file, could also read from stdout).
- **Server**
   Currently hosted on [Render](https://dashboard.render.com/) at https://bfr-data-analysis-backend.onrender.com/  
   Other options to consider: Amazon AWS (12-month free trial), Netlify

### Usage
- Get [URL]: Returns a string signifying connection status to the two databases
- Post [URL]/api/data: To upload a new data entry to the database, not password-protected. Requires request body to be a JSON containing: { "collection": the two super folders of the data entry separated by a slash, "uploader": uploader's name, "name": name of the data, "fileName": original file's name, "dataDate": a string that represents when this data was acquired (may not be parsable as a Date object), "comments": additional comments, "data": the contents of the log file }
- Del [URL]/api/data: To delete a data entry from the database, password-protected. Requires request body to be a JSON containing: { "collection": the two super folders of the data entry separated by a slash, "name": name of the data, "password": the deletion password }
- Get [URL]/api/datatree: To get a tree data structure of all data entries in the database. No parameters required. Returns an array of type: { "name": name of the folder/data, "next": an array of the same object type representing its children folders/data }
- Get [URL]/api/plot: To get a plotly graph coded in HTML from data. Requires query to provide: "collection": the data's 2 super folders' names separated by a slash, "name": data's name, "plot": a comma-separated string listing the keys of the data types to be displayed on the graph, "parser": name of the parser, "extraArgs": (optional) additional flags and arguments to be passed to the Python script

### Code Structure
- connections/: utility classes that connect to main & master database and exports it
- logs/: stores log files up to 14 days
- logs/.****-audit.json: logging settings
- node_modules/: installed node modules
- routes/api.js: determines how [URL]/api/ behaves
- schemas/: utility classes that help create and locate entries in MongoDB
- index.js: startup and home route
- logger.js: customized Winston logger
- .env: (SENSITIVE), stores 2 variables: "DATABASE_URL" to connect to main database and "MASTER_URL" to connect to master database, generated by MongoDB
- package-lock.json: exact, versioned dependency tree of required node modules
- package.json: required node modules
- build.sh: install all required Python and node libraries
- log2plot.py: Python script that inputs data and a data parser and outputs a Plotly graph in HTML
- mk8-data-parser.py: data parser Python script that parses log files into data types

### Deployment
On the server, run `./build.sh`, then `node index.js`
